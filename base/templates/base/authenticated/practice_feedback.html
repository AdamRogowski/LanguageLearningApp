{% extends 'base/layouts/authenticated.html' %}
{% block authenticated_content %}
<h2>
    {% if mode == "reverse" %}
        Reverse Practice Feedback
    {% else %}
        Practice Feedback
    {% endif %}
</h2>

{% if user_word.word.has_prompt_audio %}
    <audio id="prompt_audio" src="{{ user_word.word.prompt_audio.url }}?v={{ user_word.word.updated|date:'U' }}" autoplay>
        Your browser does not support the audio element.
    </audio>
    
    <!-- Audio autoplay message -->
    <div id="audio-autoplay-message" class="audio-autoplay-message" style="display: none;">
        <div class="audio-autoplay-content">
            Audio autoplay was blocked by your browser. Please check your browser settings to allow audio playback for this site, or click the "ðŸ”Š Play Prompt Audio" button below.
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var audio = document.getElementById('prompt_audio');
            var messageDiv = document.getElementById('audio-autoplay-message');
            
            if (audio) {
                // Try to play automatically
                var playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(function() {
                        // Automatic playback started
                        console.log('Audio autoplay successful');
                    }).catch(function(error) {
                        // Auto-play was prevented
                        console.log('Audio autoplay prevented:', error);
                        
                        // Show the message popup
                        if (messageDiv) {
                            messageDiv.style.display = 'block';
                            setTimeout(function() {
                                messageDiv.style.display = 'none';
                            }, 5000); // Show for 5 seconds
                        }
                        
                        // Add a manual play button
                        var playButton = document.createElement('button');
                        playButton.textContent = 'ðŸ”Š Play Prompt Audio';
                        playButton.onclick = function() {
                            audio.play();
                            this.style.display = 'none';
                        };
                        audio.parentNode.insertBefore(playButton, audio.nextSibling);
                    });
                }
            }
        });
    </script>
    
    <style>
        .audio-autoplay-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 193, 7, 0.95);
            color: #000;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            min-width: 200px;
            max-width: 350px;
            font-size: 1rem;
        }
        .audio-autoplay-content {
            font-weight: 500;
        }
    </style>
{% endif %}

{% if correct %}
    <div style="color: green;"><strong>Correct!</strong></div>
    {% if lev_distance > 0 %}
        <div>
            Your answer: <code>{{ answer }}</code><br>
            Correct answer: <code>{{ diff_html|safe }}</code><br>
        </div>
    {% endif %}
    <form method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit" autofocus>Continue</button>
    </form>
{% else %}
    <div style="color: red;">
        <strong>Incorrect!</strong><br>
        Your answer: <code>{{ answer }}</code><br>
        Difference: <code>{{ diff_html|safe }}</code><br>
        <form method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit" name="accept_as_correct" value="1">Accept my answer as correct</button>
            <button type="submit" autofocus>Continue</button>
        </form>
    </div>
{% endif %}

<form method="get" action="{% url 'edit-word' user_word.id %}" style="display:inline;">
    <input type="hidden" name="next" value="{% url 'practice-feedback' user_lesson_id=user_lesson_id mode=mode %}">
    <button type="submit">Edit This Word</button>
</form>
<!-- Rollout for hint, usage, and notes -->
<div>
    <button type="button" onclick="toggleRollout('hint')">Show/Hide Hint</button>
    <div id="hint" style="display:none; margin-bottom:1em;">
        <em>{{ user_word.word.hint|default:"No hint available." }}</em>
    </div>
</div>
<div>
    <button type="button" onclick="toggleRollout('usage')">Show/Hide Usage</button>
    <div id="usage" style="display:none; margin-bottom:1em;">
        <em>{{ user_word.word.usage|default:"No usage example available." }}</em>
        {% if user_word.word.has_usage_audio %}
            <audio id="usage_audio" src="{{ user_word.word.usage_audio.url }}?v={{ user_word.word.updated|date:'U' }}"></audio>
            <button type="button" onclick="document.getElementById('usage_audio').play()">ðŸ”Š Listen to usage</button>
        {% elif user_word.word.usage %}
            <button type="button" disabled title="Audio not generated for this word" class="audio-disabled">ðŸ”‡ No audio</button>
        {% endif %}
    </div>
</div>
<div>
    <button type="button" onclick="toggleRollout('notes')">Show/Hide Notes</button>
    <div id="notes" style="display:none;">
        <em>{{ user_word.notes|default:"No notes available." }}</em>
    </div>
</div>

<form method="post" action="{% url 'cancel-practice' user_lesson_id=user_lesson_id %}">
    {% csrf_token %}
    <button type="submit">Cancel Practice</button>
</form>

<script>
function toggleRollout(id) {
    var el = document.getElementById(id);
    if (el.style.display === "none") {
        el.style.display = "block";
    } else {
        el.style.display = "none";
    }
}
</script>

<style>
.diff {
    background-color: #ffcccc;
    color: #a00;
    font-weight: bold;
}
</style>
{% endblock authenticated_content %}