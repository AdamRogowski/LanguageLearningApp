{% extends "main.html" %}

{% block content %}

<!-- Page Title -->
<h1 style="color: white; font-size: 32px; margin-bottom: 20px;">
  <a href="{% url 'lessons-repository' %}" 
     style="text-decoration: none; color: #1E90FF;">
    üìö Lessons Repository
  </a>
</h1>

<!-- Search Form -->
<form method="GET" action="{% url 'lessons-repository' %}" 
      style="margin-bottom: 30px; display: flex; justify-content: center;">
  <input type="text" name="q" placeholder="Search lessons..." 
         style="padding: 10px; width: 250px; border-radius: 6px; border: none; margin-right: 10px;">
  <button type="submit" 
          style="padding: 10px 20px; background-color: #1E90FF; color: white; border: none; border-radius: 6px; cursor: pointer;">
    üîç Search
  </button>
</form>

<!-- Hover Style -->
<style>
  .lesson-box {
    background-color: #ffffff10;
    padding: 15px 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
    transition: transform 0.2s ease, background-color 0.3s ease;
  }

  .lesson-box:hover {
    background-color: #1e90ff30;
    transform: scale(1.02);
  }

  .lesson-box a {
    text-decoration: none;
    color: #00c3ff;
    font-size: 18px;
    font-weight: bold;
    display: block;
  }
</style>

<!-- Lessons List -->
<div class="lessons-repository-container" 
     style="display: flex; flex-direction: column; align-items: center; gap: 15px;">

  {% for lesson in public_lessons %}
    <div class="lesson-box">
      <a href="{% url 'lesson-details' lesson.id %}">üìñ {{ lesson.title }}</a>
    </div>
  {% empty %}
    <p style="color: white;">No lessons found.</p>
  {% endfor %}

</div>

<script>
    {% if public_lessons %}
        const lessons = [
            {% for lesson in public_lessons %}
                {
                    id: "{{ lesson.id }}",
                    title: `{{ lesson.title|escapejs }}`,
                    url: "{% url 'lesson-details' lesson.id %}"
                },
            {% endfor %}
        ];
        localStorage.setItem('cached_lessons', JSON.stringify(lessons));
    {% endif %}
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const searchForm = document.querySelector("form");
        const input = document.querySelector("input[name='q']");
        const resultsDiv = document.querySelector(".lessons-repository-container");

        if (!navigator.onLine) {
            const lessons = JSON.parse(localStorage.getItem('cached_lessons') || "[]");

            searchForm.addEventListener("submit", function(e) {
                e.preventDefault();
                const query = input.value.toLowerCase();
                const filtered = lessons.filter(lesson =>
                    lesson.title.toLowerCase().includes(query)
                );

                resultsDiv.innerHTML = "";
                if (filtered.length === 0) {
                    resultsDiv.innerHTML = "<p style='color:white;'>No lessons found.</p>";
                }

                filtered.forEach(lesson => {
                    const box = document.createElement("div");
                    box.className = "lesson-box";
                    box.innerHTML = `<a href="${lesson.url}">üìñ ${lesson.title}</a>`;
                    resultsDiv.appendChild(box);
                });
            });
        }
    });
</script>
<p id="offline-warning" style="text-align:center; color: orange; display:none;">
  ‚ö†Ô∏è You are offline. Showing cached lessons only.
</p>
<script>
    if (!navigator.onLine) {
        document.getElementById("offline-warning").style.display = "block";
    }
</script>

{% endblock content %}
